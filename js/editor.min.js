Vue.component("obj",{props:["objinfo","i","page"],methods:{saveData(){this.$emit("setdata")},setFocus(){this.$el.focus();document.getElementById("objText"+(this.i+1)).classList.add("is-active");document.querySelector("#objText"+(this.i+1)+">.delete").classList.remove("is-invisible");this.$emit("thisblur")},deFocus(){document.getElementById("objText"+(this.i+1)).classList.remove("is-active");document.querySelector("#objText"+(this.i+1)+">.delete").classList.add("is-invisible")}},computed:{textCss(){var style="";style+="text-decoration:"+this.objinfo.decoration+";";style+="text-align:"+this.objinfo.align+";";style+="font-weight:"+this.objinfo.weight+";";style+="font-style:"+this.objinfo.style+";";style+="font-size:"+this.objinfo.size+"px;";style+="font-family:'"+this.objinfo.font+"';";style+="color:"+this.objinfo.color+";";return style},imageCss(){var style="";style+="border-radius:"+this.objinfo.radius+"%;";style+="filter:hue-rotate("+this.objinfo.hue+"deg) drop-shadow(0 0 "+this.objinfo.shadowSize+"px rgba(0,0,0,"+this.objinfo.shadowOpacity+"));";return style}},template:`
    
    <div :id="'obj'+(this.i+1)" class="editor-obj" tabindex="0" ondblclick="v.objClick(event)" @click="saveData()" @blur="deFocus()" @mousedown="setFocus()" @dblclick="$emit('thisfocus')" @focus="setFocus()" :data-x="objinfo.position[0]" :data-y="objinfo.position[1]" :style='objinfo.css'>
      <div class='resizers'>
        <div class='resizer top left'></div>
        <div class='resizer top right'></div>
        <div class='resizer bottom left'></div>
        <div class='resizer bottom right'></div>
        <!-- TEXT -->
        <div v-if="objinfo.type==='text'" :style="textCss" class="content obj-normal-text">{{objinfo.value.split(' ').join('&nbsp;') || 'ดับเบิลคลิกเพื่อแก้ไข...'}}</div>
        <!-- IMAGE -->
        <img v-else-if="objinfo.type==='image'" :src="objinfo.src.trim() || './img/placeholder.jpg'" :alt="objinfo.src" :style="imageCss" class="content obj-image">
        <!-- STICKER -->
        <img v-else-if="objinfo.type==='sticker'" :src="objinfo.src.trim() || './img/placeholder.jpg'" :alt="objinfo.src" :style="imageCss" class="content obj-sticker">
        <!-- PAGE NUMBER -->
        <div v-else-if="objinfo.type==='page-number'" :style="textCss" class="content obj-page-number">{{page}}</div>
      </div>
    </div>
  `});var v=new Vue({el:"#editor",data:{zoomFactor:100,isMounted:!1,currentPage:0,isFileModalOn:!1,isCssModalOn:!1,isScreenshoted:!1,stickersList:["hanlow.png","hanrun.png","hansleep.png","meowfly.png","meowstand.png","meowwink.png"],isStickerModalOn:!1,tempCss:"",tempFileName:"",tempFileDesc:"",currentFocus:-1,editorPanelPos:[0,0],panelMouseDown:!1,isChanged:!1,wasNewOrLoad:!1,file:{name:"Untitled",desc:"",isLandscape:!1,paperSize:!1,pages:[{elements:[]}]}},watch:{file:{handler(){if(this.wasNewOrLoad){this.isChanged=!1;this.wasNewOrLoad=!1}else{this.isChanged=!0}},deep:!0}},methods:{addSticker(id){this.file.pages[this.currentPage].elements.push({type:"sticker",src:"./stickers/"+this.stickersList[id],radius:0,hue:0,shadowSize:0,shadowOpacity:0.5,position:[0,0],css:"width:150px;height:150px;"});this.isStickerModalOn=!1},newFile(){this.file={name:"Untitled",desc:"",isLandscape:!1,paperSize:!1,pages:[{elements:[]}]};this.currentPage=0;this.tempCss="";this.tempFileName="";this.tempFileDesc="";this.currentFocus=-1;this.wasNewOrLoad=!0},deleteElement(id=-1){this.currentFocus=-1;if(id==-1){this.file.pages[this.currentPage].elements.splice(this.currentFocus,1)}else{this.file.pages[this.currentPage].elements.splice(id,1)}},thaiType(type){switch(type){case "text":return"ข้อความ";break;case "image":return"รูปภาพ";break;case "sticker":return"สติกเกอร์";break;case "page-number":return"เลขที่หน้า";break}},saveFile(type=0){var data=JSON.stringify(this.file);if(type==0){data=LZString.compressToUTF16(data)}
var blob=new Blob([data],{type:"text/plain"});var e=document.createEvent("MouseEvents"),a=document.createElement("a");if(type==0){a.download=this.file.name+".bptd"}else{a.download=this.file.name+".json"}
a.href=window.URL.createObjectURL(blob);a.dataset.downloadurl=["text/json",a.download,a.href].join(":");e.initEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null);a.dispatchEvent(e);this.isChanged=!1},textToggle(target,type){switch(type){case 0:target.weight=target.weight==="normal"?"bold":"normal";break;case 1:target.style=target.style==="normal"?"italic":"normal";break;case 2:target.decoration=target.decoration==="none"?"underline":"none";break;case 3:target.align="left";break;case 4:target.align="center";break;case 5:target.align="right";break}},cssToJSON(cssStr){var newStr=cssStr.split(";");if(newStr[newStr.length-1]==""){newStr.pop()}
newStr=newStr.map(t=>`"${t.trim()}"`);newStr=newStr.join(",");newStr=newStr.split(":");newStr=newStr.map(t=>t.trim());newStr=newStr.join('":"');newStr="{"+newStr+"}";newStr=JSON.parse(newStr);return newStr},JSONToCss(jsonObj){var newCss=JSON.stringify(jsonObj).split("");newCss.pop();newCss.shift();newCss.push(";");newCss=newCss.join("");newCss=newCss.split('"');newCss=newCss.join("");newCss=newCss.split(",");newCss=newCss.join(";");return newCss},objClick(e){var rect=e.target.parentNode.parentNode.parentNode.parentNode.getBoundingClientRect(),x=e.clientX-rect.left,y=e.clientY-rect.top,isText=e.target.lastChild.classList.contains('obj-normal-text'),isImg=e.target.lastChild.classList.contains('obj-image'),isSticker=e.target.lastChild.classList.contains('obj-sticker');if(y>rect.height/2){y-=20;if(isText){y-=265.09}else if(isImg){y-=231.91}else if(isSticker){y-=183.55}else{y-=216.73}}else{y+=20}
if(x>rect.width/2){x-=20+335}else{x+=20}
this.editorPanelPos=[x,y]},updatePanelPos(){this.editorPanelPos[0]=this.$refs["editor-panel"].getAttribute("data-x");this.editorPanelPos[1]=this.$refs["editor-panel"].getAttribute("data-y")},setData(i){var data=this.file.pages[this.currentPage].elements[i];var el=document.getElementById("obj"+(i+1));data.position[0]=el.getAttribute("data-x");data.position[1]=el.getAttribute("data-y");data.css=el.style.cssText},addPage(){this.file.pages.push({elements:[]});this.currentFocus=-1;this.currentPage=this.file.pages.length-1},deletePage(){if(this.currentPage==this.file.pages.length-1){this.currentPage--;this.file.pages.splice(this.currentPage+1,1)}else{this.file.pages.splice(this.currentPage,1)}},setFocusObj(i=1){document.getElementById("obj"+i).focus()},toggleModal(){if(!this.isFileModalOn){this.isFileModalOn=!0;this.tempFileName=this.file.name;this.tempFileDesc=this.file.desc}else{this.isFileModalOn=!1;this.file.name=this.tempFileName;this.file.desc=this.tempFileDesc}},toggleCssModal(){if(!this.isCssModalOn){this.tempCss=this.JSONToCss(this.cssToJSON(this.file.pages[this.currentPage].elements[this.currentFocus].css));this.isCssModalOn=!0}else{this.file.pages[this.currentPage].elements[this.currentFocus].css=this.tempCss;this.isCssModalOn=!1}},nextPage(isNext=!0){if(isNext){this.currentPage+1<this.file.pages.length&&(this.currentFocus=-1)&&+this.currentPage++}else{this.currentPage-1>=0&&(this.currentFocus=-1)&&+this.currentPage--}},zoom(isZoom=!0){this.zoomFactor=isZoom?+this.zoomFactor+1:+this.zoomFactor-1},addElement(type=0){switch(type){case 0:this.file.pages[this.currentPage].elements.push({type:"text",value:"",font:"Kanit",size:"16",weight:"normal",decoration:"none",style:"normal",align:"left",color:"#000",position:[0,0],css:"width:150px;height:30px;top:0;left:0;"});break;case 1:this.file.pages[this.currentPage].elements.push({type:"image",src:"",radius:0,hue:0,shadowSize:0,shadowOpacity:0.5,position:[0,0],css:"width:100px;height:100px;top:0;left:0;"});break;case 3:this.file.pages[this.currentPage].elements.push({type:"page-number",font:"Kanit",size:"16",weight:"normal",decoration:"none",style:"normal",align:"left",color:"#000",position:[0,0],css:"width:40px;height:40px;top:0;left:0;"});break}
setTimeout(()=>{this.setFocusObj(this.file.pages[this.currentPage].elements.length)},1)}},computed:{pagePlusOne(){return this.currentPage+1},paperDimension(){var padding=24,widthRatio=21/29.7,heightRatio=1.0;if(this.file.isLandscape){widthRatio=1.0;heightRatio=21/29.7}
if(this.isMounted){var style="";if(!this.file.paperSize){var width=this.$refs.workspace.offsetWidth||{offsetWidth:500},height=this.$refs.workspace.offsetHeight||{offsetHeight:500},scale=+this.zoomFactor/100;width=width-padding*2;height=height-padding*2;if(width>height){style=`width:${height * widthRatio}px; height:${height *
              heightRatio}px; transform:scale(${scale}) translate(-50%,-50%);`;this.file.paperSize=[height,height]}else{style=`width:${width * widthRatio}px; height:${width *
              heightRatio}px; transform:scale(${scale}) translate(-50%,-50%);`;this.file.paperSize=[width,width]}
this.file.paperSize[0]*=widthRatio;this.file.paperSize[1]*=heightRatio}else{style=`width:${this.file.paperSize[0]}px; height:${
            this.file.paperSize[1]
          }px; transform:scale(${scale}) translate(-50%,-50%);`}
return style}
return}},mounted(){this.isMounted=!0}});(function(){function fileChange(event){var fileType=['bptd','json'],extension=event.target.files[0].name.split('.').pop().toLowerCase();if(fileType.indexOf(extension)>-1){var reader=new FileReader();reader.onload=e=>{var res=e.target.result;(extension=='bptd')&&(res=LZString.decompressFromUTF16(e.target.result));v.file=JSON.parse(res)};reader.readAsText(event.target.files[0]);v.wasNewOrLoad=!0;v.currentPage=0;v.tempCss="";v.tempFileName="";v.tempFileDesc="";v.currentFocus=-1;document.getElementById("fileLoader").value=''}else{alert("ชนิดของไฟล์ไม่ถูกต้อง! รับเฉพาะไฟล์ *.bptd หรือ *.json เท่านั้น")}}
document.getElementById('fileLoader').addEventListener('change',fileChange);window.onbeforeunload=function(){if(v.isChanged){return"อ๊ะ อ๊ะ! คุณกำลังออกจากหน้านี้โดยไม่บันทึกงานก่อน ต้องการออกจากหน้านี้หรือไม่?"}}}())